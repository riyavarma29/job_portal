 {% extends 'app/index.html' %}
{% load humanize %}
{% block content %}

<h2 class="chat-heading">Chat with {{ receiver.username }}</h2>

<div class="chat-box">
  <div class="messages" id="messageContainer">
    {% for msg in messages %}
      <div class="message-bubble {% if msg.sender == user %}sent{% else %}received{% endif %}">
        <div class="sender-name"><strong>{{ msg.sender.username }}</strong></div>
        <div class="message-content">
          {% if msg.file %}
            <a href="{{ msg.file.url }}" target="_blank" class="file-link">{{ msg.file.name|slice:"11:"|truncatechars:20 }}</a><br>
          {% endif %}
          {{ msg.content }}
          {% if msg.sender == user %}
            <span class="tick">{% if msg.seen %}✔✔{% else %}✔{% endif %}</span>
          {% endif %}
        </div>
        <div class="timestamp">{{ msg.timestamp|naturaltime }}</div>
      </div>
    {% endfor %}
  </div>
  <form id="chat-form" method="POST" enctype="multipart/form-data">
  {% csrf_token %}
  <div class="chat">
    <input type="file" name="file" id="file-input" hidden>
    <input type="text" id="message-input" name="content" placeholder="Type a message">
    <label for="file-input" class="file-icon"><i class="fas fa-paperclip"></i></label>
    <button type="submit" class="send-btn"><i class="fas fa-paper-plane"></i></button>
    </div>
</form>
</div>


{% endblock %}
{% block extra_scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const roomName = "{{ room_name }}";
    const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + roomName + '/');

    const form = document.getElementById("chat-form");
    const input = document.getElementById("message-input");
    const fileInput = document.getElementById("file-input");
    const container = document.getElementById("messageContainer");
    form.onsubmit = async function (e) {
      e.preventDefault();
      const formData = new FormData(form);
      const message = input.value.trim();
      const file = fileInput.files[0];

      if (file) {
        const response = await fetch("", {
          method: "POST",
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        if (response.ok) {
          fileInput.value = "";
          input.value = "";
          setTimeout(() => {
            container.scrollTop = container.scrollHeight;
          }, 100);
        }

        return false;
      }

      if (message && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({
          message: message,
          receiver: "{{ receiver.username }}"
        }));
        input.value = "";
      }
    };

    chatSocket.onmessage = function (e) {
      const data = JSON.parse(e.data);

      if (data.type === 'seen') {
        document.querySelectorAll('.message-bubble.sent .tick').forEach(tick => {
          tick.textContent = '✔✔';
          tick.style.color = 'blue';
        });
        return;
      }

      const div = document.createElement("div");
      div.className = "message-bubble " + (data.sender === "{{ user.username }}" ? "sent" : "received");
      div.innerHTML = `
        <div class="sender-name"><strong>${data.sender}</strong></div>
        <div class="message-content">
          ${data.file_url ? `<a href="${data.file_url}" target="_blank">${data.file_name || "File"}</a><br>` : ""}
          ${data.message}
          ${data.sender === "{{ user.username }}" ? (data.seen ? '<span class="tick" style="color:blue;">✔✔</span>' : '<span class="tick">✔</span>') : ''}
        </div>
        <div class="timestamp">just now</div>
      `;
      container.appendChild(div);
      setTimeout(() => {
        container.scrollTop = container.scrollHeight;
      }, 100);
    };
  });
</script>
{% endblock %}
